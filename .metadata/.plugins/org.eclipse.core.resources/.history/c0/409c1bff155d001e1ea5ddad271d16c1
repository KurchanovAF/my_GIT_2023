#include "interface_AD5668.h"


#define DAC_nCS_Pin GPIO_PIN_12
#define DAC_nCS_GPIO_Port GPIOB


void AD5668_Init(void){
	// —·ÓÒ
	AD5668_Reset();

	volatile uint8_t rx = 0;
	// Õ‡ÒÚ‡Ë‚‡ÂÏ SPI2 ‰Îˇ ‡·ÓÚ˚ Ò ÷¿œÓÏ
	// Disable SPI peripheral
	SPI2->CR1 &= ~SPI_CR1_SPE;
	// Õ‡ÒÚ‡Ë‚‡ÂÏ SPI2 ‰Îˇ ‡·ÓÚ˚ Ò ÷¿œÓÏ
	// CPOL = 1
	SPI2->CR1 |= SPI_CR1_CPOL;
	// CPHA = 0
	SPI2->CR1 &= ~SPI_CR1_CPHA;	
	// Enable SPI peripheral
	SPI2->CR1 |= SPI_CR1_SPE;
	// —·ÓÒ Ì‡ ÁÌ‡˜ÂÌËˇ ÔÓ ÛÏÓÎ˜‡ÌË˛
		
	uint32_t sendData = AD5668_REF | AD5668_REF_OFF;
	static uint8_t data[4];
	data[0] = ((sendData >> 24) & 0xFF);
	data[1] = ((sendData >> 16) & 0xFF);
	data[2] = ((sendData >> 8) & 0xFF);
	data[3] = ((sendData >> 0) & 0xFF);
	// –í—ã–±–æ—Ä –º–∏–∫—Ä–æ—Å—Ö–µ–º—ã –¶–ê–ü–∞
	HAL_GPIO_WritePin(DAC_nCS_GPIO_Port, DAC_nCS_Pin, GPIO_PIN_RESET);
	// –ñ–¥–µ–º –∫–æ–≥–¥–∞ DR –æ—Å–æ–≤–æ–±–æ–¥–∏—Ç—Å—è –Ω–∞ –∑–∞–ø–∏—Å—å
  while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
  *((__IO uint8_t *)&SPI2->DR) = data[0];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	*((__IO uint8_t *)&SPI2->DR) = data[1];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
  *((__IO uint8_t *)&SPI2->DR) = data[2];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	*((__IO uint8_t *)&SPI2->DR) = data[3];
	// –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	// –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø—É—Å—Ç–æ—à–µ–Ω–∏—è FIFO
	while (((SPI2->SR) & (SPI_SR_FTLVL)) != 0){};
	while (((SPI2->SR) & (SPI_SR_BSY)) == (SPI_SR_BSY)){}; 
	// –§–∏–∫—Å–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
	HAL_GPIO_WritePin(DAC_nCS_GPIO_Port, DAC_nCS_Pin, GPIO_PIN_SET);
	SPI2->CR1 &= ~SPI_CR1_SPE;	
	while (((SPI2->SR) & (SPI_SR_FRLVL)) != 0){
		rx = *((__IO uint8_t *)&SPI2->DR);
	};	
	
}
// –†–∞–±–æ—Ç–∞–µ–º —Å –≤–Ω–µ—à–Ω–∏–º –¶–ê–ü–æ–º –ø–æ SPI2
void AD5668_SetValue(uint32_t chanel, int value){
	volatile uint8_t rx = 0;
	if (value <= 0){value = 0;}
	if (value >= 65535){value = 65535;}		
	
	// Disable SPI peripheral
	SPI2->CR1 &= ~SPI_CR1_SPE;
	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SPI2 –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¶–ê–ü–æ–º
	// CPOL = 1
	SPI2->CR1 |= SPI_CR1_CPOL;
	// CPHA = 0
	SPI2->CR1 &= ~SPI_CR1_CPHA;	
	// Enable SPI peripheral
	SPI2->CR1 |= SPI_CR1_SPE;
 
	uint32_t sendData = AD5668_WRITE_AND_UPDATE_N | chanel | AD5668_VALUE(value);
	static uint8_t data[4];
	data[0] = ((sendData >> 24) & 0xFF);
	data[1] = ((sendData >> 16) & 0xFF);
	data[2] = ((sendData >> 8) & 0xFF);
	data[3] = ((sendData >> 0) & 0xFF);	
	// –í—ã–±–æ—Ä –º–∏–∫—Ä–æ—Å—Ö–µ–º—ã –¶–ê–ü–∞
	HAL_GPIO_WritePin(DAC_nCS_GPIO_Port, DAC_nCS_Pin, GPIO_PIN_RESET);
	// –ñ–¥–µ–º –∫–æ–≥–¥–∞ DR –æ—Å–æ–≤–æ–±–æ–¥–∏—Ç—Å—è –Ω–∞ –∑–∞–ø–∏—Å—å
  while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
  *((__IO uint8_t *)&SPI2->DR) = data[0];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	*((__IO uint8_t *)&SPI2->DR) = data[1];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
  *((__IO uint8_t *)&SPI2->DR) = data[2];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	*((__IO uint8_t *)&SPI2->DR) = data[3];
	// –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	// –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø—É—Å—Ç–æ—à–µ–Ω–∏—è FIFO
	while (((SPI2->SR) & (SPI_SR_FTLVL)) != 0){};
	while (((SPI2->SR) & (SPI_SR_BSY)) == (SPI_SR_BSY)){}; 
	// –§–∏–∫—Å–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
	HAL_GPIO_WritePin(DAC_nCS_GPIO_Port, DAC_nCS_Pin, GPIO_PIN_SET);	
	SPI2->CR1 &= ~SPI_CR1_SPE;	
	while (((SPI2->SR) & (SPI_SR_FRLVL)) != 0){
		rx = *((__IO uint8_t *)&SPI2->DR);
	};

}


// –†–∞–±–æ—Ç–∞–µ–º —Å –≤–Ω–µ—à–Ω–∏–º –¶–ê–ü–æ–º –ø–æ SPI2
void AD5668_WriteValue(uint32_t chanel, int value){
	volatile uint8_t rx = 0;
	if (value < 0){value = 0;}
	//value &= 0xFFFF;
	if (value >= 65535){value = 65535;}
	
	// Disable SPI peripheral
	SPI2->CR1 &= ~SPI_CR1_SPE;
	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SPI2 –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¶–ê–ü–æ–º
	// CPOL = 1
	SPI2->CR1 |= SPI_CR1_CPOL;
	// CPHA = 0
	SPI2->CR1 &= ~SPI_CR1_CPHA;	
	// Enable SPI peripheral
	SPI2->CR1 |= SPI_CR1_SPE;
 
	uint32_t sendData = AD5668_WRITE_N | chanel | AD5668_VALUE(value);
	static uint8_t data[4];
	data[0] = ((sendData >> 24) & 0xFF);
	data[1] = ((sendData >> 16) & 0xFF);
	data[2] = ((sendData >> 8) & 0xFF);
	data[3] = ((sendData >> 0) & 0xFF);	
	// –í—ã–±–æ—Ä –º–∏–∫—Ä–æ—Å—Ö–µ–º—ã –¶–ê–ü–∞
	HAL_GPIO_WritePin(DAC_nCS_GPIO_Port, DAC_nCS_Pin, GPIO_PIN_RESET);
	// –ñ–¥–µ–º –∫–æ–≥–¥–∞ DR –æ—Å–æ–≤–æ–±–æ–¥–∏—Ç—Å—è –Ω–∞ –∑–∞–ø–∏—Å—å
  while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
  *((__IO uint8_t *)&SPI2->DR) = data[0];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	*((__IO uint8_t *)&SPI2->DR) = data[1];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
  *((__IO uint8_t *)&SPI2->DR) = data[2];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	*((__IO uint8_t *)&SPI2->DR) = data[3];
	// –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	// –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø—É—Å—Ç–æ—à–µ–Ω–∏—è FIFO
	while (((SPI2->SR) & (SPI_SR_FTLVL)) != 0){};
	while (((SPI2->SR) & (SPI_SR_BSY)) == (SPI_SR_BSY)){}; 
	// –§–∏–∫—Å–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
	HAL_GPIO_WritePin(DAC_nCS_GPIO_Port, DAC_nCS_Pin, GPIO_PIN_SET);	
	SPI2->CR1 &= ~SPI_CR1_SPE;	
	while (((SPI2->SR) & (SPI_SR_FRLVL)) != 0){
		rx = *((__IO uint8_t *)&SPI2->DR);
	};
}

// –°–±—Ä–æ—Å –∑–Ω–∞—á–µ–Ω–∏–π –º–∏–∫—Ä–æ—Å—Ö–µ–º –ø–æ—É–º–æ–ª—á–∞–Ω–∏—é
void AD5668_Reset(void){
	volatile uint8_t rx = 0;
	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SPI2 –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¶–ê–ü–æ–º
	// Disable SPI peripheral
	SPI2->CR1 &= ~SPI_CR1_SPE;
	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SPI2 –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¶–ê–ü–æ–º
	// CPOL = 1
	SPI2->CR1 |= SPI_CR1_CPOL;
	// CPHA = 0
	SPI2->CR1 &= ~SPI_CR1_CPHA;	
	// Enable SPI peripheral
	SPI2->CR1 |= SPI_CR1_SPE;
	// –°–±—Ä–æ—Å –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
	uint32_t sendData = AD5668_RESET;
	static uint8_t data[4];
	data[0] = ((sendData >> 24) & 0xFF);
	data[1] = ((sendData >> 16) & 0xFF);
	data[2] = ((sendData >> 8) & 0xFF);
	data[3] = ((sendData >> 0) & 0xFF);
	// –í—ã–±–æ—Ä –º–∏–∫—Ä–æ—Å—Ö–µ–º—ã –¶–ê–ü–∞
	HAL_GPIO_WritePin(DAC_nCS_GPIO_Port, DAC_nCS_Pin, GPIO_PIN_RESET);
	// –ñ–¥–µ–º –∫–æ–≥–¥–∞ DR –æ—Å–æ–≤–æ–±–æ–¥–∏—Ç—Å—è –Ω–∞ –∑–∞–ø–∏—Å—å
  while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
  *((__IO uint8_t *)&SPI2->DR) = data[0];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	*((__IO uint8_t *)&SPI2->DR) = data[1];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
  *((__IO uint8_t *)&SPI2->DR) = data[2];
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	*((__IO uint8_t *)&SPI2->DR) = data[3];
	// –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
	while (((SPI2->SR) & (SPI_SR_TXE)) != (SPI_SR_TXE)){};
	// –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø—É—Å—Ç–æ—à–µ–Ω–∏—è FIFO
	while (((SPI2->SR) & (SPI_SR_FTLVL)) != 0){};
	while (((SPI2->SR) & (SPI_SR_BSY)) == (SPI_SR_BSY)){}; 
	// –§–∏–∫—Å–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
	HAL_GPIO_WritePin(DAC_nCS_GPIO_Port, DAC_nCS_Pin, GPIO_PIN_SET);	
	SPI2->CR1 &= ~SPI_CR1_SPE;	
	while (((SPI2->SR) & (SPI_SR_FRLVL)) != 0){
		rx = *((__IO uint8_t *)&SPI2->DR);
	};
}

